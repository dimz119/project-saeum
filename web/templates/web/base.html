{% load compress %}
{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MonthlyLook - 스타일리시한 월간 패션{% endblock %}</title>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    {% compress css %}
    <link rel="stylesheet" href="{% static 'web/css/style.css' %}">
    {% endcompress %}
    
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- React Router CDN -->
    <script crossorigin src="https://unpkg.com/react-router-dom@6/dist/umd/react-router-dom.production.min.js"></script>
</head>
<body>
    <div id="root">
        {% block content %}
        <!-- React 앱이 여기에 마운트됩니다 -->
        <div style="padding: 20px; text-align: center;">
            <h1>Loading...</h1>
            <p>If you see this message, React is not loading properly.</p>
        </div>
        {% endblock %}
    </div>
    
    <!-- JavaScript -->
    <script>
        // Components 객체 미리 초기화
        window.Components = window.Components || {};
        console.log('Components object initialized:', window.Components);
    </script>
    <script src="{% static 'web/src/config.js' %}"></script>
    <script src="{% static 'web/src/utils/api.js' %}"></script>
    <script src="{% static 'web/src/utils/cart.js' %}"></script>
    <script src="{% static 'web/src/utils/auth.js' %}"></script>
    <script src="{% static 'web/src/components/AuthProvider.js' %}"></script>
    <script src="{% static 'web/src/components/Header.js' %}"></script>
    <script src="{% static 'web/src/components/Hero.js' %}"></script>
    <script src="{% static 'web/src/components/ProductCard.js' %}"></script>
    <script src="{% static 'web/src/components/ProductList.js' %}"></script>
    <script src="{% static 'web/src/components/ProductDetail.js' %}"></script>
    <script src="{% static 'web/src/components/Cart.js' %}"></script>
    <script src="{% static 'web/src/components/CheckoutSuccess.js' %}"></script>
    <script src="{% static 'web/src/components/WishlistPage.js' %}"></script>
    <script src="{% static 'web/src/components/SearchPage.js' %}"></script>
    <script src="{% static 'web/src/App.js' %}"></script>
    
    <script>
        // auth 객체가 이미 auth.js에서 생성되므로 추가 설정 불필요
        
        // 메인 페이지에서만 React 앱 초기화 (로그인/회원가입 페이지 제외)
        document.addEventListener('DOMContentLoaded', function() {
            const root = document.getElementById('root');
            const path = window.location.pathname;
            
            console.log('Page loaded, path:', path);
            
            // 로그인/회원가입 페이지가 아닌 경우에만 메인 앱 렌더링
            if (root && path !== '/login/' && path !== '/register/') {
                console.log('Loading main app for path:', path);
                
                let attempts = 0;
                const maxAttempts = 20; // 최대 2초 대기
                
                const renderApp = () => {
                    attempts++;
                    console.log(`Render attempt ${attempts}/${maxAttempts}`);
                    console.log('Current state:', {
                        Components: !!window.Components,
                        App: !!(window.Components && window.Components.App),
                        AuthProvider: !!window.AuthProvider,
                        React: !!window.React,
                        ReactDOM: !!window.ReactDOM
                    });
                    
                    if (window.Components && window.Components.App) {
                        console.log('Rendering App with AuthProvider');
                        // AuthProvider와 App을 한번에 렌더링
                        if (window.AuthProvider) {
                            ReactDOM.render(
                                React.createElement(window.AuthProvider, null,
                                    React.createElement(window.Components.App)
                                ),
                                root
                            );
                        } else {
                            // AuthProvider가 없으면 App만 렌더링
                            ReactDOM.render(
                                React.createElement(window.Components.App),
                                root
                            );
                        }
                        console.log('App successfully rendered');
                    } else if (attempts < maxAttempts) {
                        console.log('App component not ready, retrying...');
                        setTimeout(renderApp, 100);
                    } else {
                        console.error('Failed to load App component after maximum attempts');
                        root.innerHTML = '<div style="padding: 20px; text-align: center; color: red;"><h2>앱 로딩 실패</h2><p>페이지를 새로고침해주세요.</p></div>';
                    }
                };
                
                // 약간의 지연 후 렌더링 시작 (스크립트 로딩 완료 대기)
                setTimeout(renderApp, 200);
            } else {
                console.log('Skipping main app rendering for:', path);
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
